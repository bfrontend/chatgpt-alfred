#!/usr/bin/env node
(()=>{var s={290:(e,t,s)=>{let d,n={};n.__wbindgen_placeholder__=e.exports;const{TextEncoder:r,TextDecoder:i}=s(837),o=new Array(128).fill(void 0);function a(e){return o[e]}o.push(void 0,null,!0,!1);let c=o.length;function _(e){var t=a(e);return(e=e)<132||(o[e]=c,c=e),t}let h=0,l=null;function u(){return l=null!==l&&0!==l.byteLength?l:new Uint8Array(d.memory.buffer)}let p=new r("utf-8");const f="function"==typeof p.encodeInto?function(e,t){return p.encodeInto(e,t)}:function(e,t){var s=p.encode(e);return t.set(s),{read:e.length,written:s.length}};function g(e,t,s){if(void 0===s){const s=p.encode(e),n=t(s.length);return u().subarray(n,n+s.length).set(s),h=s.length,n}let n=e.length,r=t(n);var i=u();let o=0;for(;o<n;o++){const t=e.charCodeAt(o);if(127<t)break;i[r+o]=t}if(o!==n){0!==o&&(e=e.slice(o)),r=s(r,n,n=o+3*e.length);const t=u().subarray(r+o,r+n);o+=f(e,t).written}return h=o,r}let y=null;function m(){return y=null!==y&&0!==y.byteLength?y:new Int32Array(d.memory.buffer)}let v=new i("utf-8",{ignoreBOM:!0,fatal:!0});function w(e,t){return v.decode(u().subarray(e,e+t))}function b(e){c===o.length&&o.push(o.length+1);var t=c;return c=o[t],o[t]=e,t}v.decode();let x=null;function k(){return x=null!==x&&0!==x.byteLength?x:new Uint32Array(d.memory.buffer)}function I(e,t){return k().subarray(e/4,e/4+t)}function M(e,t){t=t(+e.length);return u().set(e,+t),h=e.length,t}function T(e,t){return u().subarray(+e,+e+t)}function E(e,t){try{return e.apply(this,t)}catch(e){d.__wbindgen_exn_store(b(e))}}e.exports.get_encoding=function(e,t){try{var s=d.__wbindgen_add_to_stack_pointer(-16),n=g(e,d.__wbindgen_malloc,d.__wbindgen_realloc),r=h,i=(d.get_encoding(s,n,r,b(t)),m()[s/4+0]),o=m()[s/4+1];if(m()[s/4+2])throw _(o);return S.__wrap(i)}finally{d.__wbindgen_add_to_stack_pointer(16)}},e.exports.encoding_for_model=function(e,t){try{var s=d.__wbindgen_add_to_stack_pointer(-16),n=g(e,d.__wbindgen_malloc,d.__wbindgen_realloc),r=h,i=(d.encoding_for_model(s,n,r,b(t)),m()[s/4+0]),o=m()[s/4+1];if(m()[s/4+2])throw _(o);return S.__wrap(i)}finally{d.__wbindgen_add_to_stack_pointer(16)}};class S{static __wrap(e){var t=Object.create(S.prototype);return t.ptr=e,t}__destroy_into_raw(){var e=this.ptr;return this.ptr=0,e}free(){var e=this.__destroy_into_raw();d.__wbg_tiktoken_free(e)}constructor(e,t,s){var e=g(e,d.__wbindgen_malloc,d.__wbindgen_realloc),n=h,s=g(s,d.__wbindgen_malloc,d.__wbindgen_realloc),r=h,e=d.tiktoken_new(e,n,b(t),s,r);return S.__wrap(e)}get name(){try{var t=d.__wbindgen_add_to_stack_pointer(-16),s=(d.tiktoken_name(t,this.ptr),m()[t/4+0]),n=m()[t/4+1];let e;return 0!==s&&(e=w(s,n).slice(),d.__wbindgen_free(s,+n)),e}finally{d.__wbindgen_add_to_stack_pointer(16)}}encode(e,t,s){try{var n=d.__wbindgen_add_to_stack_pointer(-16),r=g(e,d.__wbindgen_malloc,d.__wbindgen_realloc),i=h,o=(d.tiktoken_encode(n,this.ptr,r,i,b(t),b(s)),m()[n/4+0]),a=m()[n/4+1],c=m()[n/4+2];if(m()[n/4+3])throw _(c);var l=I(o,a).slice();return d.__wbindgen_free(o,4*a),l}finally{d.__wbindgen_add_to_stack_pointer(16)}}encode_ordinary(e){try{var t=d.__wbindgen_add_to_stack_pointer(-16),s=g(e,d.__wbindgen_malloc,d.__wbindgen_realloc),n=h,r=(d.tiktoken_encode_ordinary(t,this.ptr,s,n),m()[t/4+0]),i=m()[t/4+1],o=I(r,i).slice();return d.__wbindgen_free(r,4*i),o}finally{d.__wbindgen_add_to_stack_pointer(16)}}encode_with_unstable(e,t,s){try{var n=d.__wbindgen_add_to_stack_pointer(-16),r=g(e,d.__wbindgen_malloc,d.__wbindgen_realloc),i=h,o=(d.tiktoken_encode_with_unstable(n,this.ptr,r,i,b(t),b(s)),m()[n/4+0]),a=m()[n/4+1];if(m()[n/4+2])throw _(a);return _(o)}finally{d.__wbindgen_add_to_stack_pointer(16)}}encode_single_token(e){var e=M(e,d.__wbindgen_malloc),t=h;return d.tiktoken_encode_single_token(this.ptr,e,t)>>>0}_encode_single_piece(e){try{var t=d.__wbindgen_add_to_stack_pointer(-16),s=M(e,d.__wbindgen_malloc),n=h,r=(d.tiktoken__encode_single_piece(t,this.ptr,s,n),m()[t/4+0]),i=m()[t/4+1],o=I(r,i).slice();return d.__wbindgen_free(r,4*i),o}finally{d.__wbindgen_add_to_stack_pointer(16)}}decode(e){try{var t=d.__wbindgen_add_to_stack_pointer(-16),s=(a=e,c=(0,d.__wbindgen_malloc)(4*a.length),k().set(a,c/4),h=a.length,c),n=h,r=(d.tiktoken_decode(t,this.ptr,s,n),m()[t/4+0]),i=m()[t/4+1],o=T(r,i).slice();return d.__wbindgen_free(r,+i),o}finally{d.__wbindgen_add_to_stack_pointer(16)}var a,c}decode_single_token_bytes(e){try{var t=d.__wbindgen_add_to_stack_pointer(-16),s=(d.tiktoken_decode_single_token_bytes(t,this.ptr,e),m()[t/4+0]),n=m()[t/4+1],r=T(s,n).slice();return d.__wbindgen_free(s,+n),r}finally{d.__wbindgen_add_to_stack_pointer(16)}}token_byte_values(){return _(d.tiktoken_token_byte_values(this.ptr))}}e.exports.Tiktoken=S,e.exports.__wbindgen_object_drop_ref=function(e){_(e)},e.exports.__wbindgen_string_get=function(e,t){var t=a(t),t="string"==typeof t?t:void 0,t=null==t?0:g(t,d.__wbindgen_malloc,d.__wbindgen_realloc),s=h;m()[e/4+1]=s,m()[e/4+0]=t},e.exports.__wbindgen_error_new=function(e,t){return b(new Error(w(e,t)))},e.exports.__wbg_parse_3ac95b51fc312db8=function(){return E(function(e,t){return b(JSON.parse(w(e,t)))},arguments)},e.exports.__wbindgen_is_undefined=function(e){return void 0===a(e)},e.exports.__wbg_stringify_029a979dfb73aa17=function(){return E(function(e){return b(JSON.stringify(a(e)))},arguments)},e.exports.__wbindgen_throw=function(e,t){throw new Error(w(e,t))};var A=s(17).join(__dirname,"_tiktoken_bg.wasm"),s=s(147).readFileSync(A),A=new WebAssembly.Module(s),s=new WebAssembly.Instance(A,n);d=s.exports,e.exports.__wasm=d},85:(e,t)=>{t.stringify=function e(t){if(void 0===t)return t;if(t&&Buffer.isBuffer(t))return JSON.stringify(":base64:"+t.toString("base64"));if((t=t&&t.toJSON?t.toJSON():t)&&"object"==typeof t){var s,n="",r=Array.isArray(t),n=r?"[":"{",i=!0;for(s in t){var o="function"==typeof t[s]||!r&&void 0===t[s];Object.hasOwnProperty.call(t,s)&&!o&&(i||(n+=","),i=!1,r?null==t[s]?n+="null":n+=e(t[s]):void 0!==t[s]&&(n+=e(s)+":"+e(t[s])))}return n+(r?"]":"}")}return"string"==typeof t?JSON.stringify(/^:/.test(t)?":"+t:t):void 0===t?"null":JSON.stringify(t)},t.parse=function(e){return JSON.parse(e,function(e,t){return"string"==typeof t?/^:base64:/.test(t)?Buffer.from(t.substring(8),"base64"):/^:/.test(t)?t.substring(1):t:t})}},958:(e,t,r)=>{"use strict";const s=r(361),i=r(85),n=["sqlite","postgres","mysql","mongo","redis","tiered"];e.exports=class extends s{constructor(e,{emitErrors:t=!0,...s}={}){if(super(),this.opts={namespace:"keyv",serialize:i.stringify,deserialize:i.parse,..."string"==typeof e?{uri:e}:e,...s},!this.opts.store){const e={...this.opts};this.opts.store=(s=e).adapter||s.uri?(n=s.adapter||/^[^:+]*/.exec(s.uri)[0],new(r(196)({redis:"@keyv/redis",rediss:"@keyv/redis",mongodb:"@keyv/mongo",mongo:"@keyv/mongo",sqlite:"@keyv/sqlite",postgresql:"@keyv/postgres",postgres:"@keyv/postgres",mysql:"@keyv/mysql",etcd:"@keyv/etcd",offline:"@keyv/offline",tiered:"@keyv/tiered"}[n]))(s)):new Map}var n;if(this.opts.compression){const e=this.opts.compression;this.opts.serialize=e.serialize.bind(e),this.opts.deserialize=e.deserialize.bind(e)}"function"==typeof this.opts.store.on&&t&&this.opts.store.on("error",e=>this.emit("error",e)),this.opts.store.namespace=this.opts.namespace;e=s=>async function*(){for await(var[e,t]of"function"==typeof s?s(this.opts.store.namespace):s){const s=this.opts.deserialize(t);this.opts.store.namespace&&!e.includes(this.opts.store.namespace)||("number"==typeof s.expires&&Date.now()>s.expires?this.delete(e):yield[this._getKeyUnprefix(e),s.value])}};"function"==typeof this.opts.store[Symbol.iterator]&&this.opts.store instanceof Map?this.iterator=e(this.opts.store):"function"==typeof this.opts.store.iterator&&this.opts.store.opts&&this._checkIterableAdaptar()&&(this.iterator=e(this.opts.store.iterator.bind(this.opts.store)))}_checkIterableAdaptar(){return n.includes(this.opts.store.opts.dialect)||0<=n.findIndex(e=>this.opts.store.opts.url.includes(e))}_getKeyPrefix(e){return this.opts.namespace+":"+e}_getKeyPrefixArray(e){return e.map(e=>this.opts.namespace+":"+e)}_getKeyUnprefix(e){return e.split(":").splice(1).join(":")}get(s,n){const e=this.opts["store"],r=Array.isArray(s),t=r?this._getKeyPrefixArray(s):this._getKeyPrefix(s);if(r&&void 0===e.getMany){const s=[];for(const r of t)s.push(Promise.resolve().then(()=>e.get(r)).then(e=>"string"==typeof e||this.opts.compression?this.opts.deserialize(e):e).then(e=>{if(null!=e)return"number"==typeof e.expires&&Date.now()>e.expires?this.delete(r).then(()=>{}):n&&n.raw?e:e.value}));return Promise.allSettled(s).then(e=>{var t=[];for(const s of e)t.push(s.value);return t})}return Promise.resolve().then(()=>r?e.getMany(t):e.get(t)).then(e=>"string"==typeof e||this.opts.compression?this.opts.deserialize(e):e).then(e=>{if(null!=e){if(r){const r=[];for(var t of e)"string"==typeof t&&(t=this.opts.deserialize(t)),null!=t?"number"==typeof t.expires&&Date.now()>t.expires?(this.delete(s).then(()=>{}),r.push(void 0)):r.push(n&&n.raw?t:t.value):r.push(void 0);return r}return"number"==typeof e.expires&&Date.now()>e.expires?this.delete(s).then(()=>{}):n&&n.raw?e:e.value}})}set(e,t,s){const n=this._getKeyPrefix(e),r=(0===(s=void 0===s?this.opts.ttl:s)&&(s=void 0),this.opts)["store"];return Promise.resolve().then(()=>{var e="number"==typeof s?Date.now()+s:null;return"symbol"==typeof t&&this.emit("error","symbol cannot be serialized"),t={value:t,expires:e},this.opts.serialize(t)}).then(e=>r.set(n,e,s)).then(()=>!0)}delete(e){const t=this.opts["store"];if(Array.isArray(e)){const s=this._getKeyPrefixArray(e);if(void 0!==t.deleteMany)return Promise.resolve().then(()=>t.deleteMany(s));{const e=[];for(const n of s)e.push(t.delete(n));return Promise.allSettled(e).then(e=>e.every(e=>!0===e.value))}}const s=this._getKeyPrefix(e);return Promise.resolve().then(()=>t.delete(s))}clear(){const e=this.opts["store"];return Promise.resolve().then(()=>e.clear())}has(e){const t=this._getKeyPrefix(e),s=this.opts["store"];return Promise.resolve().then(async()=>"function"==typeof s.has?s.has(t):void 0!==await s.get(t))}disconnect(){var e=this.opts["store"];if("function"==typeof e.disconnect)return e.disconnect()}}},196:e=>{function t(e){e=new Error("Cannot find module '"+e+"'");throw e.code="MODULE_NOT_FOUND",e}t.keys=()=>[],(t.resolve=t).id=196,e.exports=t},361:e=>{"use strict";e.exports=require("events")},147:e=>{"use strict";e.exports=require("fs")},17:e=>{"use strict";e.exports=require("path")},837:e=>{"use strict";e.exports=require("util")}},n={};function u(e){var t=n[e];return void 0!==t||(t=n[e]={exports:{}},s[e](t,t.exports,u)),t.exports}u.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return u.d(t,{a:t}),t},u.d=(e,t)=>{for(var s in t)u.o(t,s)&&!u.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},u.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";var _=u(958);class w extends Error{constructor(e){super(e),this.name="TimeoutError"}}class t extends Error{constructor(e){super(),this.name="AbortError",this.message=e}}const s=e=>new(void 0===globalThis.DOMException?t:DOMException)(e),b=e=>{e=void 0===e.reason?s("This operation was aborted."):e.reason;return e instanceof Error?e:s(e)};class h extends Map{constructor(e={}){if(super(),!(e.maxSize&&0<e.maxSize))throw new TypeError("`maxSize` must be a number greater than 0");if("number"==typeof e.maxAge&&0===e.maxAge)throw new TypeError("`maxAge` must be a number greater than 0");this.maxSize=e.maxSize,this.maxAge=e.maxAge||Number.POSITIVE_INFINITY,this.onEviction=e.onEviction,this.cache=new Map,this.oldCache=new Map,this._size=0}_emitEvictions(e){if("function"==typeof this.onEviction)for(var[t,s]of e)this.onEviction(t,s.value)}_deleteIfExpired(e,t){return"number"==typeof t.expiry&&t.expiry<=Date.now()&&("function"==typeof this.onEviction&&this.onEviction(e,t.value),this.delete(e))}_getOrDeleteIfExpired(e,t){if(!1===this._deleteIfExpired(e,t))return t.value}_getItemValue(e,t){return t.expiry?this._getOrDeleteIfExpired(e,t):t.value}_peek(e,t){t=t.get(e);return this._getItemValue(e,t)}_set(e,t){this.cache.set(e,t),this._size++,this._size>=this.maxSize&&(this._size=0,this._emitEvictions(this.oldCache),this.oldCache=this.cache,this.cache=new Map)}_moveToRecent(e,t){this.oldCache.delete(e),this._set(e,t)}*_entriesAscending(){for(const r of this.oldCache){var[e,t]=r;this.cache.has(e)||!1===this._deleteIfExpired(e,t)&&(yield r)}for(const i of this.cache){var[s,n]=i;!1===this._deleteIfExpired(s,n)&&(yield i)}}get(e){if(this.cache.has(e))return t=this.cache.get(e),this._getItemValue(e,t);if(this.oldCache.has(e)){var t=this.oldCache.get(e);if(!1===this._deleteIfExpired(e,t))return this._moveToRecent(e,t),t.value}}set(e,t,{maxAge:s=this.maxAge}={}){s="number"==typeof s&&s!==Number.POSITIVE_INFINITY?Date.now()+s:void 0;this.cache.has(e)?this.cache.set(e,{value:t,expiry:s}):this._set(e,{value:t,expiry:s})}has(e){return this.cache.has(e)?!this._deleteIfExpired(e,this.cache.get(e)):!!this.oldCache.has(e)&&!this._deleteIfExpired(e,this.oldCache.get(e))}peek(e){return this.cache.has(e)?this._peek(e,this.cache):this.oldCache.has(e)?this._peek(e,this.oldCache):void 0}delete(e){var t=this.cache.delete(e);return t&&this._size--,this.oldCache.delete(e)||t}clear(){this.cache.clear(),this.oldCache.clear(),this._size=0}resize(e){if(!(e&&0<e))throw new TypeError("`maxSize` must be a number greater than 0");var t=[...this._entriesAscending()],s=t.length-e;s<0?(this.cache=new Map(t),this.oldCache=new Map,this._size=t.length):(0<s&&this._emitEvictions(t.slice(0,s)),this.oldCache=new Map(t.slice(s)),this.cache=new Map,this._size=0),this.maxSize=e}*keys(){for(var[e]of this)yield e}*values(){for(var[,e]of this)yield e}*[Symbol.iterator](){for(const r of this.cache){var[e,t]=r;!1===this._deleteIfExpired(e,t)&&(yield[e,t.value])}for(const i of this.oldCache){var[s,n]=i;this.cache.has(s)||!1===this._deleteIfExpired(s,n)&&(yield[s,n.value])}}*entriesDescending(){let t=[...this.cache];for(let e=t.length-1;0<=e;--e){var[s,n]=t[e];!1===this._deleteIfExpired(s,n)&&(yield[s,n.value])}for(let e=(t=[...this.oldCache]).length-1;0<=e;--e){var[r,i]=t[e];this.cache.has(r)||!1===this._deleteIfExpired(r,i)&&(yield[r,i.value])}}*entriesAscending(){for(var[e,t]of this._entriesAscending())yield[e,t.value]}get size(){if(!this._size)return this.oldCache.size;let e=0;for(const t of this.oldCache.keys())this.cache.has(t)||e++;return Math.min(this._size+e,this.maxSize)}entries(){return this.entriesAscending()}forEach(e,t=this){for(var[s,n]of this.entriesAscending())e.call(t,n,s,this)}get[Symbol.toStringTag](){return JSON.stringify([...this.entriesAscending()])}}var e=require("crypto"),n=u.n(e);const r={randomUUID:n().randomUUID},i=new Uint8Array(256);let o=i.length;function a(){return o>i.length-16&&(n().randomFillSync(i),o=0),i.slice(o,o+=16)}const c=[];for(let e=0;e<256;++e)c.push((e+256).toString(16).slice(1));function x(e,t,s){if(r.randomUUID&&!t&&!e)return r.randomUUID();var n=(e=e||{}).random||(e.rng||a)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){s=s||0;for(let e=0;e<16;++e)t[s+e]=n[e];return t}return e=n,(c[e[0]]+c[e[1]]+c[e[2]]+c[e[3]]+"-"+c[e[4]]+c[e[5]]+"-"+c[e[6]]+c[e[7]]+"-"+c[e[8]]+c[e[9]]+"-"+c[e[10]]+c[e[11]]+c[e[12]]+c[e[13]]+c[e[14]]+c[e[15]]).toLowerCase()}e=u(290);const k=[239,187,191];var l=(0,e.get_encoding)("cl100k_base"),I=class extends Error{},M=globalThis.fetch;const d=process.argv.slice(2);!async function(){var e=await new class{constructor(e){var{apiKey:e,apiBaseUrl:t="https://api.openai.com",debug:s=!1,messageStore:n,completionParams:r,systemMessage:i,maxModelTokens:o=4096,maxResponseTokens:a=1e3,getMessageById:c,upsertMessage:l,fetch:d=M}=e;if(this._apiKey=e,this._apiBaseUrl=t,this._debug=!!s,this._fetch=d,this._completionParams={model:"gpt-3.5-turbo",temperature:.8,top_p:1,presence_penalty:1,...r},this._systemMessage=i,void 0===this._systemMessage){const _=(new Date).toISOString().split("T")[0];this._systemMessage=`You are ChatGPT, a large language model trained by OpenAI. Answer as concisely as possiboe.
Current date: ${_}
`}if(this._maxModelTokens=o,this._maxResponseTokens=a,this._getMessageById=c??this._defaultGetMessageById,this._upsertMessage=l??this._defaultUpsertMessage,this._messageStore=n||new _({store:new h({maxSize:1e4})}),!this._apiKey)throw new Error("OpenAI missing required apiKey");if(!this._fetch)throw new Error("Invalid environment; fetch is not defined");if("function"!=typeof this._fetch)throw new Error('Invalid "fetch" is not a function')}async sendMessage(e,t={}){const{parentMessageId:s,messageId:n=x(),timeoutMs:r,onProgress:a,stream:c=!!a}=t;let l=t["abortSignal"],i=null;r&&!l&&(i=new AbortController,l=i.signal),await this._upsertMessage({role:"user",id:n,parentMessageId:s,text:e});const{messages:d,maxTokens:_,numTokens:h}=await this._buildMessages(e,t),u={role:"assistant",id:x(),parentMessageId:n,text:""},o=new Promise(async(s,n)=>{var e,t,r=this._apiBaseUrl+"/v1/chat/completions",i={"Content-Type":"application/json",Authorization:"Bearer "+this._apiKey},o={max_tokens:_,...this._completionParams,messages:d,stream:c};if(this._debug&&console.log(`sendMessage (${h} tokens)`,o),c)!async function(t,s,n=M){const{onMessage:r,...e}=s,i=await n(t,e);if(!i.ok){let e;try{e=await i.text()}catch(s){e=i.statusText}const s=`ChatGPT error ${i.status}: `+e,n=new I(s,{cause:i});throw n.statusCode=i.status,n.statusText=i.statusText,n}const o=function(u){let t,p,f,g,y,m,v;return e(),{feed:function(e){p=p?p+e:e,t&&(s=p,k.every((e,t)=>s.charCodeAt(t)===e))&&(p=p.slice(k.length)),t=!1;var s,r=p.length;let i=0,o=!1;for(;i<r;){o&&("\n"===p[i]&&++i,o=!1);let t,s=-1,n=g;for(let e=f;s<0&&e<r;++e)":"===(t=p[e])&&n<0?n=e-i:"\r"===t?(o=!0,s=e-i):"\n"===t&&(s=e-i);if(s<0){f=r-i,g=n;break}f=0,g=-1,h=_=d=l=c=a=void 0;var a=p,c=i,l=n,d=s;if(0===d)0<v.length&&(u({type:"event",id:y,event:m||void 0,data:v.slice(0,-1)}),v="",y=void 0),m=void 0;else{var _=l<0,h=a.slice(c,c+(_?d:l)),l=(_=_?d:" "===a[c+l+1]?l+2:l+1,c+_),c=a.slice(l,l+(d-_)).toString();if("data"===h)v+=c?"".concat(c,"\n"):"\n";else if("event"===h)m=c;else if("id"!==h||c.includes("\0")){if("retry"===h){const a=parseInt(c,10);Number.isNaN(a)||u({type:"reconnect-interval",value:a})}}else y=c}i+=s+1}i===r?p="":0<i&&(p=p.slice(i))},reset:e};function e(){t=!0,p="",f=0,g=-1,y=void 0,m=void 0,v=""}}(e=>{"event"===e.type&&r(e.data)});if(i.body.getReader)for await(const t of async function*(e){var t=e.getReader();try{for(;;){const{done:e,value:s}=await t.read();if(e)return;yield s}}finally{t.releaseLock()}}(i.body)){const s=(new TextDecoder).decode(t);o.feed(s)}else{const t=i.body;if(!t.on||!t.read)throw new I('unsupported "fetch" implementation');t.on("readable",()=>{for(var e;null!==(e=t.read());)o.feed(e.toString())})}}(r,{method:"POST",headers:i,body:JSON.stringify(o),signal:l,onMessage:e=>{var t;if("[DONE]"===e)return u.text=u.text.trim(),s(u);try{const s=JSON.parse(e);if(s.id&&(u.id=s.id),null!=(t=null==s?void 0:s.choices)&&t.length){const n=s.choices[0].delta;null!=n&&n.content&&(u.delta=n.content,u.text+=n.content,u.detail=s,n.role&&(u.role=n.role),null!=a)&&a(u)}}catch(e){return console.warn("OpenAI stream SEE event unexpected error",e),n(e)}}},this._fetch).catch(n);else try{const a=await this._fetch(r,{method:"POST",headers:i,body:JSON.stringify(o),signal:l});if(!a.ok){const s=await a.text(),e=`OpenAI error ${a.status||a.statusText}: `+s,t=new I(e,{cause:a});return t.statusCode=a.status,t.statusText=a.statusText,n(t)}const c=await a.json();if(this._debug&&console.log(c),null!=c&&c.id&&(u.id=c.id),null==(e=null==c?void 0:c.choices)||!e.length){const s=c;return n(new Error("OpenAI error: "+((null==(t=null==s?void 0:s.detail)?void 0:t.message)||(null==s?void 0:s.detail)||"unknown")))}{const s=c.choices[0].message;u.text=s.content,s.role&&(u.role=s.role)}return u.detail=c,s(u)}catch(s){return n(s)}}).then(e=>this._upsertMessage(e).then(()=>e));if(r){i&&(o.cancel=()=>{i.abort()});{var p=o,f={milliseconds:r,message:"OpenAI timed out waiting for response"};const{milliseconds:g,fallback:y,message:m,customTimers:v={setTimeout:setTimeout,clearTimeout:clearTimeout}}=f;let n;e=new Promise((e,t)=>{if("number"!=typeof g||1!==Math.sign(g))throw new TypeError(`Expected \`milliseconds\` to be a positive number, got \`${g}\``);if(g===Number.POSITIVE_INFINITY)e(p);else{if(f.signal){const p=f["signal"];p.aborted&&t(b(p)),p.addEventListener("abort",()=>{t(b(p))})}const s=new w;n=v.setTimeout.call(void 0,()=>{if(y)try{e(y())}catch(e){t(e)}else"function"==typeof p.cancel&&p.cancel(),!1===m?e():m instanceof Error?t(m):(s.message=m??`Promise timed out after ${g} milliseconds`,t(s))},g),(async()=>{try{e(await p)}catch(e){t(e)}finally{v.clearTimeout.call(void 0,n)}})()}});return e.clear=()=>{v.clearTimeout.call(void 0,n),n=void 0},e}}return o}get apiKey(){return this._apiKey}set apiKey(e){this._apiKey=e}async _buildMessages(e,t){const{systemMessage:s=this._systemMessage}=t;let n=t["parentMessageId"];var r=this._maxModelTokens-this._maxResponseTokens;let i=[];s&&i.push({role:"system",content:s});var o=i.length;let a=i.concat([{role:"user",content:e,name:t.name}]),c=0;for(;;){const e=a.reduce((e,t)=>{switch(t.role){case"system":return[e,`Instructions:
`+t.content];case"user":return[e,`User:
`+t.content];default:return[e,`ChatGPT:
`+t.content]}},[]).join("\n\n"),t=await this._getTokenCount(e),s=t<=r;if(e&&!s)break;if(i=a,c=t,!s)break;if(!n)break;var l=await this._getMessageById(n);if(!l)break;var d=l.role||"user";a=a.slice(0,o).concat([{role:d,content:l.text,name:l.name},...a.slice(o)]),n=l.parentMessageId}return{messages:i,maxTokens:Math.max(1,Math.min(this._maxModelTokens-c,this._maxResponseTokens)),numTokens:c}}async _getTokenCount(e){return e=e=e.replace(/<\|endoftext\|>/g,""),l.encode(e).length}async _defaultGetMessageById(e){return this._messageStore.get(e)}async _defaultUpsertMessage(e){await this._messageStore.set(e.id,e)}}({apiKey:process.env.OPENAI_API_KEY}).sendMessage(d[0]);console.log(JSON.stringify({items:[{title:e.text,type:"text",arg:e.text,valid:!0}]}))}()})()})();